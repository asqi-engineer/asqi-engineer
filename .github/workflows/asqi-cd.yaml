name: ASQI Project Pipeline

on:
  push:
    branches: [ main ]
    tags: [ 'v*.*.*' ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    uses: ./.github/workflows/lint.yaml
  test:
    uses: ./.github/workflows/test.yaml

  security:
    uses: ./.github/workflows/security.yaml

  build-publish-container:
    needs: [ lint, test,  security ]
    permissions:
      packages: write
      id-token: write
      contents: read
      attestations: write
    uses: ./.github/workflows/asqi-container-publish.yaml
    secrets: inherit

  build-publish-library:
    if: startsWith(github.ref, 'refs/tags/v')
    # inlined as pypa publisher does not support reusable workflows yet
    needs: [ lint, test, security ]
    permissions:
      id-token: write
      contents: read
    runs-on: ubuntu-latest
    environment:
      name: pypi
    strategy:
      matrix:
        python-version: [ '3.12' ]
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: ğŸ” Verify git state
        run: |
          echo "=== Git Description ==="
          git describe --tags --always --dirty
          echo "=== Current Commit ==="
          git log -1 --oneline
          echo "=== Tags at HEAD ==="
          git tag --points-at HEAD
          echo "=== Distance from tag ==="
          git describe --tags --long
          echo "=== setuptools-scm version detection ==="
          python -m setuptools_scm || echo "setuptools-scm not available yet"

      - name: ğŸ“¦ Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: ğŸ Set up uv and Python
        run: |
          uv venv
          source .venv/bin/activate

      - name: ğŸ› ï¸ Install build dependencies
        run: |
          uv sync --locked --python ${{ matrix.python-version }} --group dev

      - name: ğŸ”¨ Build package
        run: uv build --wheel

      - name: ğŸ” Detect uncommitted schema changes
        run: |
          if ! git diff --quiet -- src/asqi/schemas/; then
            echo "=== âŒ Schema files are out-of-date ==="
            git diff --stat -- src/asqi/schemas/
            echo "=== Run and Push ==="
            echo "  uv run scripts/generate_schemas.py"
            exit 1
          fi
          echo "=== Schemas are up-to-date ==="

      - name: ğŸ” Verify built version
        run: |
          ls -la dist/
          echo "Built wheel:"
          ls dist/*.whl

      - name: ğŸ§ª Test wheel installation
        run: |
          set -e
          uv venv /tmp/test-wheel-env --python ${{ matrix.python-version }}
          . /tmp/test-wheel-env/bin/activate
          uv pip install dist/*.whl
          asqi --help

      - name: ğŸš€ Publish to PyPI
        # This action uses OIDC to securely authenticate with PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
